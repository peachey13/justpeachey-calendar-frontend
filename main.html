<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Just Peachey Rentals at The Lake - Availability Calendar</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --peach-light: #FFDFB8;
      --peach-primary: #FFB17A;
      --peach-secondary: #FF9559;
      --peach-dark: #E16B3F;
      --peach-text: #5D3A1E;
      --green-available: #78B672;
      --green-accent: #78A27D;
      --cream-bg: #FFFAF0;
      --gray-light: #F0F0F0;
      --gray-medium: #D0D0D0;
      --red-booked: #E25C5C;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100vh;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      background-color: transparent;
      color: var(--peach-text);
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 80vh;
      background-color: transparent;
    }
    
    /* Title section - compact */
    .title-section {
      padding: 15px 20px 10px 20px;
      text-align: center;
      background-color: transparent;
    }
    
    .title-section h1 {
      color: var(--peach-dark);
      font-weight: 600;
      font-size: clamp(1.5rem, 4vw, 2.2rem);
      margin: 0;
    }
    
    /* Main content - takes remaining space */
    .main-content {
      flex: 1;
      display: flex;
      padding: 0 20px 0 20px;
      gap: 20px;
      min-height: 0;
    }
    
    /* Bottom buffer - simple spacing */
    .bottom-buffer {
      height: 20px;
    }
    
    /* Calendar section - takes up remaining space */
    .calendar-section {
      flex: 1;
      background-color: var(--cream-bg);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }
    
    #calendar {
      flex: 1;
      min-height: 0; /* Important for flex child */
    }
    
    .legend {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 15px;
      flex-wrap: wrap;
      padding: 10px 0;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.85rem;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      margin-right: 5px;
      border-radius: 3px;
    }
    
    /* Sidebar section - fixed width */
    .sidebar-section {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .booking-summary {
      background-color: var(--cream-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      text-align: center;
    }
    
    .booking-dates {
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: var(--peach-text);
    }
    
    .booking-dates div {
      margin-bottom: 5px;
    }
    
    .booking-dates strong {
      color: var(--peach-dark);
    }
    
    #total-price {
      font-size: 1.1rem;
      font-weight: 500;
      margin: 15px 0;
      color: var(--peach-text);
      min-height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #checkout-button {
      background-color: var(--green-available);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
      margin-top: 10px;
    }
    
    #checkout-button:hover {
      background-color: var(--green-accent);
    }
    
    #checkout-button:disabled {
      background-color: var(--gray-medium);
      cursor: not-allowed;
    }
    
    /* Calendar customization */
    .fc-theme-standard .fc-scrollgrid {
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--gray-medium);
    }
    
    .fc-col-header {
      background-color: var(--peach-primary);
    }
    
    .fc-col-header-cell-cushion {
      color: white !important;
      font-weight: 500;
      padding: 8px 0;
    }
    
    .fc-daygrid-day.fc-day-today {
      background-color: rgba(255, 177, 122, 0.1) !important;
    }
    
    .fc-day-past, 
    .fc-day-today { 
      background-color: var(--gray-light) !important; 
      color: #777 !important; 
    }
    
    .fc-daygrid-day { 
      transition: background-color 0.2s;
      cursor: pointer;
    }
    
    .fc-daygrid-day:hover {
      background-color: rgba(255, 177, 122, 0.1) !important;
    }
    
    .fc-day-selected { 
      background-color: rgba(255, 177, 122, 0.3) !important;
    }
    
    .fc-daygrid-day-number { 
      visibility: visible !important; 
      color: inherit !important;
      padding: 6px !important;
    }
    
    .fc-event {
      border-radius: 4px;
      padding: 2px 4px;
      cursor: pointer;
      border: none !important;
    }
    
    .fc-event:hover {
      opacity: 0.8;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        padding: 10px;
        gap: 15px;
      }
      
      .sidebar-section {
        width: 100%;
        order: -1; /* Put sidebar above calendar on mobile */
      }
      
      .calendar-section {
        flex: 1;
      }
      
      .booking-summary {
        padding: 15px;
      }
      
      .header-section h1 {
        font-size: 1.5rem;
      }
      
      .legend {
        gap: 10px;
      }
      
      .legend-item {
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 480px) {
      .main-content {
        padding: 5px;
      }
      
      .calendar-section {
        padding: 10px;
      }
      
      .booking-summary {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Title section - compact, no white background -->
    <div class="title-section">
      <h1>Just Peachey Rentals at The Lake Availability</h1>
    </div>
    
    <!-- Main content -->
    <div class="main-content">
      <!-- Calendar section -->
      <div class="calendar-section">
        <div id="calendar"></div>
        
        <div class="legend">
          <div class="legend-item">
            <span class="legend-color" style="background-color: var(--green-available);"></span>
            <span>Available</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background-color: var(--red-booked);"></span>
            <span>Unavailable</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background-color: rgba(255, 177, 122, 0.3);"></span>
            <span>Selected Dates</span>
          </div>
        </div>
      </div>
      
      <!-- Sidebar section -->
      <div class="sidebar-section">
        <div class="booking-summary">
          <div id="booking-dates" class="booking-dates" style="display: none;">
            <div><strong>Check-in:</strong> <span id="checkin-date">-</span></div>
            <div><strong>Check-out:</strong> <span id="checkout-date">-</span></div>
          </div>
          <p id="total-price">Select dates for your stay</p>
          <button id="checkout-button" disabled>Book Now</button>
        </div>
      </div>
    </div>
    
    <!-- Bottom buffer to show background -->
    <div class="bottom-buffer"></div>
  </div>

  <script>
    let rateData = {};
    let bookedDates = {};
    let startDate = null;
    let isLoading = true;

    // Parse ISO date format from iCal (YYYYMMDD)
    function parseICalDate(dateStr) {
      const match = dateStr.match(/(\d{4})(\d{2})(\d{2})/);
      if (match) {
        const [_, year, month, day] = match;
        return ${year}-${month}-${day};
      }
      return null;
    }

    async function fetchPrices() {
      try {
        const res = await fetch('https://pricelabs-proxy.vercel.app/api/index');
        if (!res.ok) throw new Error(HTTP error: ${res.status});
        const data = await res.json();
        
        data[0].data.forEach(day => {
          rateData[day.date] = { 
            price: day.price, 
            available: day.booking_status === "" && day.unbookable === 0 
          };
          
          if (day.booking_status !== "" || day.unbookable !== 0) {
            bookedDates[day.date] = true;
          }
        });
        
        return true;
      } catch (error) {
        console.error('Error loading prices:', error);
        document.getElementById('total-price').innerHTML = 'Error loading prices';
        return false;
      }
    }

    async function fetchAirbnbCalendar() {
      try {
        const airbnbUrl = 'https://www.airbnb.com/calendar/ical/613014927246709169.ics?s=543e042018da272e3c205debb382d2c7';
        const response = await fetch('https://justpeachey-calendar-sync.netlify.app/.netlify/functions/proxy-ical?url=' + encodeURIComponent(airbnbUrl));
        
        if (!response.ok) {
          throw new Error(HTTP error: ${response.status});
        }
        
        const icalText = await response.text();
        console.log('iCal data fetched successfully');
        
        const lines = icalText.split('\n');
        let inEvent = false;
        let eventStart = '';
        let eventEnd = '';
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          
          if (line === 'BEGIN:VEVENT') {
            inEvent = true;
            eventStart = '';
            eventEnd = '';
            continue;
          }
          
          if (line === 'END:VEVENT') {
            inEvent = false;
            
            if (eventStart && eventEnd) {
              const start = parseICalDate(eventStart);
              const end = parseICalDate(eventEnd);
              
              if (start && end) {
                let currentDate = new Date(start);
                const endDate = new Date(end);
                
                while (currentDate < endDate) {
                  const dateStr = currentDate.toISOString().split('T')[0];
                  bookedDates[dateStr] = true;
                  currentDate.setDate(currentDate.getDate() + 1);
                }
              }
            }
            continue;
          }
          
          if (inEvent) {
            if (line.startsWith('DTSTART')) {
              eventStart = line.split(':')[1];
            }
            
            if (line.startsWith('DTEND')) {
              eventEnd = line.split(':')[1];
            }
          }
        }
        
        return true;
      } catch (error) {
        console.error('Error fetching Airbnb calendar:', error);
        return false;
      }
    }

    function calculatePrice(start, end) {
      let s = new Date(start);
      let e = new Date(end);
      let nights = Math.ceil((e - s) / (1000 * 60 * 60 * 24));
      let total = 0;
      let current = new Date(s);
      let available = true;

      for (let i = 0; i < nights; i++) {
        let d = current.toISOString().split('T')[0];
        
        if (rateData[d] && rateData[d].available && !bookedDates[d]) {
          total += rateData[d].price;
        } else {
          available = false;
          break;
        }
        current.setDate(current.getDate() + 1);
      }

      if (available && nights >= 1) {
        let nightlyTotal = total;
        total += 150;
        
        // Show the selected dates
        document.getElementById('booking-dates').style.display = 'block';
        document.getElementById('checkin-date').textContent = formatDate(start);
        document.getElementById('checkout-date').textContent = formatDate(end);
        
        // Show the total
        document.getElementById('total-price').innerHTML = Total: ${total}<br><small>${nights} nights: ${nightlyTotal} + $150 cleaning fee</small>;
        document.getElementById('checkout-button').dataset.total = total;
        document.getElementById('checkout-button').dataset.checkin = start;
        document.getElementById('checkout-button').dataset.checkout = end;
        document.getElementById('checkout-button').disabled = false;
      } else {
        document.getElementById('booking-dates').style.display = 'none';
        document.getElementById('total-price').innerHTML = nights < 1 ? 'Need 1+ nights' : 'Some dates are unavailable';
        document.getElementById('checkout-button').disabled = true;
      }
    }

    function clearHighlights() {
      document.querySelectorAll('.fc-daygrid-day').forEach(day => {
        day.style.backgroundColor = '';
        day.classList.remove('fc-day-selected');
      });
    }

    function highlightRange(start, end) {
      clearHighlights();
      let s = new Date(start);
      let e = new Date(end);
      document.querySelectorAll('.fc-daygrid-day').forEach(day => {
        let d = new Date(day.getAttribute('data-date'));
        if (d >= s && d <= e) day.classList.add('fc-day-selected');
      });
    }

    function formatDate(date) {
      const options = { weekday: 'short', month: 'short', day: 'numeric' };
      return new Date(date).toLocaleDateString('en-US', options);
    }

    // Check if today is available for booking (before 7pm MST)
    function isTodayAvailableForBooking() {
      const now = new Date();
      const mstTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Denver"}));
      const currentHour = mstTime.getHours();
      return currentHour < 19; // Available before 7pm MST
    }

    function handleDateClick(date) {
      let clickedDate = new Date(date);
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to compare dates only
      clickedDate.setHours(0, 0, 0, 0); // Reset time to compare dates only
      
      const todayStr = today.toISOString().split('T')[0];
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      
      // Allow today only if before 7pm MST and not booked
      if (date === todayStr) {
        if (!isTodayAvailableForBooking()) {
          document.getElementById('total-price').innerHTML = 'Same-day bookings unavailable after 7pm MST';
          return;
        }
      }
      // Allow tomorrow if not booked
      else if (date === tomorrowStr) {
        // Tomorrow is allowed
      }
      // Block all other past dates
      else if (clickedDate < today) {
        return;
      }
      
      if (bookedDates[date] || (rateData[date] && !rateData[date].available)) {
        document.getElementById('total-price').innerHTML = 'This date is not available';
        return;
      }

      if (startDate === null) {
        clearHighlights();
        startDate = date;
        document.querySelector([data-date="${date}"]).classList.add('fc-day-selected');
        document.getElementById('booking-dates').style.display = 'none';
        document.getElementById('total-price').innerHTML = Check-in selected: ${formatDate(startDate)}<br><small>Please select checkout date</small>;
      } else {
        if (date <= startDate) {
          clearHighlights();
          startDate = date;
          document.querySelector([data-date="${date}"]).classList.add('fc-day-selected');
          document.getElementById('booking-dates').style.display = 'none';
          document.getElementById('total-price').innerHTML = Check-in selected: ${formatDate(startDate)}<br><small>Please select checkout date</small>;
        } else {
          let rangeHasUnavailableDate = false;
          let current = new Date(startDate);
          let end = new Date(date);
          
          while (current <= end) {
            let d = current.toISOString().split('T')[0];
            if (bookedDates[d] || (rateData[d] && !rateData[d].available)) {
              rangeHasUnavailableDate = true;
              break;
            }
            current.setDate(current.getDate() + 1);
          }
          
          if (rangeHasUnavailableDate) {
            document.getElementById('booking-dates').style.display = 'none';
            document.getElementById('total-price').innerHTML = 'Some dates in this range are not available';
            startDate = null;
            clearHighlights();
          } else {
            highlightRange(startDate, date);
            calculatePrice(startDate, date);
            startDate = null;
          }
        }
      }
    }

    async function initializeCalendar() {
      document.getElementById('total-price').innerHTML = 'Loading calendar data...';
      
      const [pricesLoaded, airbnbDatesLoaded] = await Promise.all([fetchPrices(), fetchAirbnbCalendar()]);
      
      if (pricesLoaded) {
        document.getElementById('total-price').innerHTML = 'Select dates for your stay';
      } else {
        document.getElementById('total-price').innerHTML = 'Some data could not be loaded. Please try again later.';
      }
      
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      const oneYear = new Date(today);
      oneYear.setFullYear(today.getFullYear() + 1);

      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        validRange: { start: '2025-03-01', end: oneYear },
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth'
        },
        height: '100%',
        dateClick: info => {
          handleDateClick(info.dateStr);
        },
        eventClick: info => {
          // Make events clickable too
          if (info.event.backgroundColor === 'var(--green-available)' || 
              info.event.backgroundColor.includes('78B672')) {
            handleDateClick(info.event.startStr);
          }
        }
      });
      
      const events = [];
      const allDates = new Set([...Object.keys(rateData), ...Object.keys(bookedDates)]);
      
      // Make sure today and tomorrow are included even if not in rateData/bookedDates
      allDates.add(todayStr);
      allDates.add(tomorrowStr);
      
      allDates.forEach(date => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0); // Reset time for comparison
        const todayCompare = new Date(today);
        todayCompare.setHours(0, 0, 0, 0);
        
        const isBooked = bookedDates[date] || (rateData[date] && !rateData[date].available);
        
        // Updated logic for today/tomorrow availability
        let eventTitle = '';
        let backgroundColor = '';
        let textColor = '#fff';
        
        if (date === todayStr) {
          // Today: available only before 7pm MST and if not booked
          if (!isTodayAvailableForBooking() || isBooked) {
            eventTitle = 'Unavailable';
            backgroundColor = 'var(--red-booked)';
          } else {
            eventTitle = ${rateData[date]?.price || 150};
            backgroundColor = 'var(--green-available)';
          }
        } else if (date === tomorrowStr) {
          // Tomorrow: available if not booked
          if (isBooked) {
            eventTitle = 'Unavailable';
            backgroundColor = 'var(--red-booked)';
          } else {
            eventTitle = ${rateData[date]?.price || 150};
            backgroundColor = 'var(--green-available)';
          }
        } else if (d < todayCompare) {
          // Past dates: unavailable
          eventTitle = '';
          backgroundColor = '#f5f5f5';
          textColor = '#777';
        } else {
          // Future dates: normal logic
          if (isBooked) {
            eventTitle = 'Unavailable';
            backgroundColor = 'var(--red-booked)';
          } else {
            eventTitle = ${rateData[date]?.price || 0};
            backgroundColor = 'var(--green-available)';
          }
        }
        
        events.push({
          title: eventTitle,
          start: date,
          allDay: true,
          backgroundColor: backgroundColor,
          textColor: textColor,
          editable: false
        });
      });
      
      calendar.addEventSource(events);
      calendar.render();
      
      // Add click handlers to day cells after calendar renders
      setTimeout(() => {
        document.querySelectorAll('.fc-daygrid-day').forEach(dayEl => {
          dayEl.addEventListener('click', (e) => {
            const date = dayEl.getAttribute('data-date');
            if (date) {
              handleDateClick(date);
            }
          });
        });
      }, 100);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeCalendar();
      
      document.getElementById('checkout-button').addEventListener('click', function() {
        let total = this.dataset.total;
        let checkin = this.dataset.checkin;
        let checkout = this.dataset.checkout;
        
        localStorage.setItem('checkin', checkin);
        localStorage.setItem('checkout', checkout);
        localStorage.setItem('total', total);
        
        window.location.href = https://justpeacheyrentals.com/checkout?booking_total=${total}&check_in=${checkin}&check_out=${checkout};
      });
    });
  </script>
</body>
</html>
